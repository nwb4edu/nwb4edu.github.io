
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spike Sorting &#8212; Teaching &amp; Learning with NWB Datasets</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Visualizing Large Scale Recordings" href="Visualizing_Recordings.html" />
    <link rel="prev" title="Lesson #2: Analyzing Extracellular Recordings" href="Large_Scale_Electrophysiology.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/nwb_learning.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Teaching & Learning with NWB Datasets</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../landing_page.html">
   Teaching and Learning with NWB Datasets
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Introduction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter_01/Introduction.html">
   Introduction
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_01/Using_This_Book.html">
     How to Use this Book
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_01/Setup.html">
     Setup
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_01/For_Educators.html">
     For Educators
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter_02/Data_Science_In_Python.html">
   Data Science in Python
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_02/NumPy.html">
     NumPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_02/Pandas.html">
     Pandas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_02/SciPy.html">
     SciPy
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  pynwb
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter_03/NWB_Dataset_Structure.html">
   Lesson #1: The Structure of NWB Datasets
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_03/Obtaining_Datasets_with_DANDI.html">
     Obtaining Datasets with DANDI
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_03/Working_with_NWB_format_in_Python.html">
     Working with NWB in Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_03/Interactive_NWB_Data_Exploration.html">
     Interactive NWB Data Exploration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_03/Chapter_3_ProblemSet.html">
     Lesson #1 Problem Set
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="Large_Scale_Electrophysiology.html">
   Lesson #2: Analyzing Extracellular Recordings
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Spike Sorting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Visualizing_Recordings.html">
     Visualizing Large Scale Recordings
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Chapter_4_ProblemSet.html">
     Lesson #2 Problem Set
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  allensdk
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter_06/Single-Cell_Electrophysiology.html">
   Lesson #3: Single-Cell Electrophysiology
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_06/Obtaining_Data_For_Single_Cells.html">
     Obtaining Data for Single Cells
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_06/Analyzing_Computed_Features.html">
     Analyzing Computed Features
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_06/Lesson3_ProblemSet.html">
     Lesson 3 Problem Set
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter_07/Two_Photon_Imaging.html">
   Lesson #4: Two Photon Imaging
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_07/Retrieving_Brain_Observatory_Data.html">
     Retrieving Calcium Imaging Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_07/Analyzing_Two_Photon_Data.html">
     Analyzing Two Photon Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_07/Correlations_in_Two_Photon_Data.html">
     Correlations in Two Photon Data
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/Chapter_04/SpikeSorting.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/nwb4edu/nwb4edu.github.io/master?urlpath=tree/Chapter_04/SpikeSorting.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/nwb4edu/nwb4edu.github.io/blob/master/Chapter_04/SpikeSorting.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-1-inspect-the-data">
   Step 1. Inspect the Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-2-spike-detection">
   Step 2. Spike Detection
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-3-feature-extraction">
   Step 3. Feature Extraction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#notebook-summary">
   Notebook summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#notes-resources">
   Notes &amp; resources
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="spike-sorting">
<h1>Spike Sorting<a class="headerlink" href="#spike-sorting" title="Permalink to this headline">¶</a></h1>
<p>When you record extracellular electrophysiology data, one of the first data processing steps is figuring out which action potentials (or “spikes”) came from which neurons. The process of doing this is called <strong>spike sorting</strong>.</p>
<p>Below, we’ll work with <a class="reference external" href="https://dandiarchive.org/dandiset/000053/0.210819.0345">this dataset</a> from <a class="reference external" href="https://giocomolab.weebly.com/">Lisa Giocomo’s lab at Stanford</a> to demonstrate the simplest form of spike sorting: thresholding, followed by feature extraction.</p>
<p><mark><strong>Note</strong>:  The code below requires a different dataset than the one we interacted with in the last chapter. Because this dataset contains all of the raw recording data, it is much, much bigger. As a result, the best way to work with it is through the Dandihub. If you’re not already running this book on the Dandihub, read <a class="reference external" href="https://nwb4edu.github.io/Chapter_01/Using_This_Book.html">“Using this Book</a> for instructions on how to run this on the Dandihub.</mark></p>
<div class="section" id="step-1-inspect-the-data">
<h2>Step 1. Inspect the Data<a class="headerlink" href="#step-1-inspect-the-data" title="Permalink to this headline">¶</a></h2>
<p>First, we need to find the correct URL for the dataset on the NWB’s Amazon S3 storage system. There is a tool to do so within the dandiapi, which we’ll use below to get the URL for one session within the dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dandi.dandiapi</span> <span class="kn">import</span> <span class="n">DandiAPIClient</span>

<span class="n">dandiset_id</span> <span class="o">=</span> <span class="s1">&#39;000053&#39;</span> <span class="c1"># giocomo data</span>
<span class="n">filepath</span> <span class="o">=</span> <span class="s1">&#39;sub-npI5/sub-npI5_ses-20190414_behavior+ecephys.nwb&#39;</span> 

<span class="k">with</span> <span class="n">DandiAPIClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
    <span class="n">asset</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_dandiset</span><span class="p">(</span><span class="n">dandiset_id</span><span class="p">,</span> <span class="s1">&#39;draft&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_asset_by_path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">s3_path</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">get_content_url</span><span class="p">(</span><span class="n">follow_redirects</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">strip_query</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="n">s3_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>https://dandiarchive.s3.amazonaws.com/blobs/d6d/882/d6d88284-983a-42a7-91e8-48e9f59c2881
</pre></div>
</div>
</div>
</div>
<p>Now that we have this path, we can stream the data rather than downloading it. Below, we’ll print some useful information about this experiment. We will also access a dataset we haven’t interacted with yet: <a class="reference external" href="https://pynwb.readthedocs.io/en/stable/tutorials/domain/ecephys.html"><code class="docutils literal notranslate"><span class="pre">ElectricalSeries</span></code></a>. As the name suggests, this group contains raw electrophysiology data – exactly what we need to sort! We will assign a portion of this to an object called <code class="docutils literal notranslate"><span class="pre">ephys_data</span></code>.</p>
<p><mark><strong>Note</strong>: The cell below will take about a minute to run, depending on the speed of your internet connection.</mark></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pynwb</span> <span class="kn">import</span> <span class="n">NWBHDF5IO</span>

<span class="k">with</span> <span class="n">NWBHDF5IO</span><span class="p">(</span><span class="n">s3_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;ros3&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
    <span class="n">nwbfile</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">nwbfile</span><span class="o">.</span><span class="n">acquisition</span><span class="p">[</span><span class="s1">&#39;ElectricalSeries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">sampling_freq</span> <span class="o">=</span> <span class="n">nwbfile</span><span class="o">.</span><span class="n">acquisition</span><span class="p">[</span><span class="s1">&#39;ElectricalSeries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rate</span> <span class="c1"># get the sampling frequency in Hz</span>
    <span class="n">ephys_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">nwbfile</span><span class="o">.</span><span class="n">acquisition</span><span class="p">[</span><span class="s1">&#39;ElectricalSeries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="mi">3000000</span><span class="p">,</span> <span class="mi">99</span><span class="p">])</span><span class="o">*</span><span class="n">nwbfile</span><span class="o">.</span><span class="n">acquisition</span><span class="p">[</span><span class="s1">&#39;ElectricalSeries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">conversion</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="n">a0fb7d19a4f</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">pynwb</span> <span class="kn">import</span> <span class="n">NWBHDF5IO</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> 
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="k">with</span> <span class="n">NWBHDF5IO</span><span class="p">(</span><span class="n">s3_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">load_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;ros3&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">io</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">nwbfile</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="nb">print</span><span class="p">(</span><span class="n">nwbfile</span><span class="o">.</span><span class="n">acquisition</span><span class="p">[</span><span class="s1">&#39;ElectricalSeries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/hdmf/utils.py</span> in <span class="ni">func_call</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">577</span>         <span class="k">if</span> <span class="n">is_method</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">578</span>             <span class="k">def</span> <span class="nf">func_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">579</span>                 <span class="n">pargs</span> <span class="o">=</span> <span class="n">_check_args</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">580</span>                 <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">pargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">581</span>         <span class="k">else</span><span class="p">:</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/hdmf/utils.py</span> in <span class="ni">_check_args</span><span class="nt">(args, kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">570</span>                 <span class="k">if</span> <span class="n">parse_err</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">571</span>                     <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parse_err</span><span class="p">))</span>
<span class="ne">--&gt; </span><span class="mi">572</span>                     <span class="k">raise</span> <span class="n">ExceptionType</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">573</span> 
<span class="g g-Whitespace">    </span><span class="mi">574</span>             <span class="k">return</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>

<span class="ne">TypeError</span>: NWBHDF5IO.__init__: unrecognized argument: &#39;driver&#39;
</pre></div>
</div>
</div>
</div>
<p>Before we dive into spike sorting, let’s take a look at the data. Below, we’ll import a couple additional packages, generate a list of timestamps, and plot it.</p>
<blockquote>
<div><p><strong>Note</strong>: Need a reminder on how some of the packages or functions below work? Look through the <a class="reference external" href="https://nwb4edu.github.io/Chapter_02/NumPy.html">NumPy</a> and <a class="reference external" href="https://nwb4edu.github.io/Chapter_02/Matplotlib.html">Matplotlib</a> review pages.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import necessary packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># generate a vector of timestamps</span>
<span class="n">timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ephys_data</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">sampling_freq</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span><span class="n">ephys_data</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Seconds (s)&#39;</span><span class="p">)</span>
<span class="c1">#plt.xlim(1.053,1.055)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>In the data above, there are clear places where the data “spikes”. These are extracellularly recorded action potentials!</p>
</div>
<div class="section" id="step-2-spike-detection">
<h2>Step 2. Spike Detection<a class="headerlink" href="#step-2-spike-detection" title="Permalink to this headline">¶</a></h2>
<p>One of the most straightforward ways to spike sort is to simply detect these using a threshold. Whenever the signal passes this threshold, we’ll clip that out. We could determine a reasonable threshold by eye, but we’ll do this mathematically instead, using the standard deviation of the signal. When the signal is five times the standard deviation, that’s enough signal to noise that it’s likely to be an action potential. We’ll calculate that below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">noise_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ephys_data</span><span class="p">)</span>
<span class="n">recommended_threshold</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span> <span class="o">*</span> <span class="n">noise_std</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Noise Estimate by Standard Deviation: &#39;</span><span class="p">,</span> <span class="n">noise_std</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Recommended Spike Threshold         : &#39;</span><span class="p">,</span> <span class="n">recommended_threshold</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Our spike detector needs to take into account that a spike typically comprises multiple samples, so we can’t simply take each sample that exceeds the threshold as an individual spike detection. Instead, we’ll define a <em>dead time</em>: whenever we detect a spike, the next few samples within the dead time won’t trigger a spike detection by themselves.</p>
<p>In order to generate a more precise idea of where each spike is we will also search for the minimum in each spike by lookiing through the signal for a short period of time after the threshold crossing. The time of this minimum will be the timestamp for each spike.</p>
<p>Below, we’ll define three helper functions to accomplish this detection strategy:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">detect_threshold_crossings</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">dead_time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect threshold crossings in a signal with dead time and return them as an array</span>
<span class="sd">    </span>
<span class="sd">    The signal transitions from a sample above the threshold to a sample below the threshold for a detection and</span>
<span class="sd">    the last detection has to be more than dead_time apart from the current one.</span>
<span class="sd">    </span>
<span class="sd">    :param signal: The signal as a 1-dimensional numpy array</span>
<span class="sd">    :param fs: The sampling frequency in Hz</span>
<span class="sd">    :param threshold: The threshold for the signal</span>
<span class="sd">    :param dead_time: The dead time in seconds. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dead_time_idx</span> <span class="o">=</span> <span class="n">dead_time</span> <span class="o">*</span> <span class="n">fs</span>
    <span class="n">threshold_crossings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">((</span><span class="n">signal</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">distance_sufficient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">threshold_crossings</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">dead_time_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">distance_sufficient</span><span class="p">):</span>
        <span class="c1"># repeatedly remove all threshold crossings that violate the dead_time</span>
        <span class="n">threshold_crossings</span> <span class="o">=</span> <span class="n">threshold_crossings</span><span class="p">[</span><span class="n">distance_sufficient</span><span class="p">]</span>
        <span class="n">distance_sufficient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">threshold_crossings</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">dead_time_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">threshold_crossings</span>

<span class="k">def</span> <span class="nf">get_next_minimum</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">max_samples_to_search</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the index of the next minimum in the signal after an index</span>
<span class="sd">    </span>
<span class="sd">    :param signal: The signal as a 1-dimensional numpy array</span>
<span class="sd">    :param index: The scalar index </span>
<span class="sd">    :param max_samples_to_search: The number of samples to search for a minimum after the index</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">search_end_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">max_samples_to_search</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">min_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">search_end_idx</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">index</span> <span class="o">+</span> <span class="n">min_idx</span>

<span class="k">def</span> <span class="nf">align_to_minimum</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">threshold_crossings</span><span class="p">,</span> <span class="n">search_range</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the index of the next negative spike peak for all threshold crossings</span>
<span class="sd">    </span>
<span class="sd">    :param signal: The signal as a 1-dimensional numpy array</span>
<span class="sd">    :param fs: The sampling frequency in Hz</span>
<span class="sd">    :param threshold_crossings: The array of indices where the signal crossed the detection threshold</span>
<span class="sd">    :param search_range: The maximum duration in seconds to search for the minimum after each crossing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">search_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">search_range</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">aligned_spikes</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_next_minimum</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">search_end</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threshold_crossings</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aligned_spikes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we can use those functions to detect threshold crossings. We’ll then plot our original signal with the detected spikes marked.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crossings</span> <span class="o">=</span> <span class="n">detect_threshold_crossings</span><span class="p">(</span><span class="n">ephys_data</span><span class="p">,</span> <span class="n">sampling_freq</span><span class="p">,</span> <span class="n">recommended_threshold</span><span class="p">,</span> <span class="mf">0.003</span><span class="p">)</span> <span class="c1"># dead time of 3 ms</span>
<span class="n">spks</span> <span class="o">=</span> <span class="n">align_to_minimum</span><span class="p">(</span><span class="n">ephys_data</span><span class="p">,</span> <span class="n">sampling_freq</span><span class="p">,</span> <span class="n">crossings</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">)</span> <span class="c1"># search range 2 ms</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ephys_data</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Samples&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Voltage (uV)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spks</span><span class="p">,[</span><span class="n">recommended_threshold</span><span class="p">]</span><span class="o">*</span><span class="n">spks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">)</span>
<span class="c1">#plt.xlim([0,len(ephys_data)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we can cut out the waveforms from these detected spikes so that we can look at their shape. To do so, we will cut out a portion of the signal around each spike. Spikes too close to the start or end of the signal that a full cutout is not possible are ignored.</p>
<p>The location and shape of a waveform is one of the main pieces of evidence to show that the waveform was recorded from a cell. This will help us determine whether or not there is just one or more neurons recorded on this channel.</p>
<p>Below, we will define two helper functions: one to extract the waveforms, and one to plot them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">extract_waveforms</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">spikes_idx</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract spike waveforms as signal cutouts around each spike index as a spikes x samples numpy array</span>
<span class="sd">    </span>
<span class="sd">    :param signal: The signal as a 1-dimensional numpy array</span>
<span class="sd">    :param fs: The sampling frequency in Hz</span>
<span class="sd">    :param spikes_idx: The sample index of all spikes as a 1-dim numpy array</span>
<span class="sd">    :param pre: The duration of the cutout before the spike in seconds</span>
<span class="sd">    :param post: The duration of the cutout after the spike in seconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cutouts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pre_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pre</span> <span class="o">*</span> <span class="n">fs</span><span class="p">)</span>
    <span class="n">post_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">post</span> <span class="o">*</span> <span class="n">fs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">spikes_idx</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">-</span><span class="n">pre_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">index</span><span class="o">+</span><span class="n">post_idx</span> <span class="o">&lt;=</span> <span class="n">signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">cutout</span> <span class="o">=</span> <span class="n">signal</span><span class="p">[(</span><span class="n">index</span><span class="o">-</span><span class="n">pre_idx</span><span class="p">):(</span><span class="n">index</span><span class="o">+</span><span class="n">post_idx</span><span class="p">)]</span>
            <span class="n">cutouts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cutout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">cutouts</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_waveforms</span><span class="p">(</span><span class="n">cutouts</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot an overlay of spike cutouts</span>
<span class="sd">    </span>
<span class="sd">    :param cutouts: A spikes x samples array of cutouts</span>
<span class="sd">    :param fs: The sampling frequency in Hz</span>
<span class="sd">    :param pre: The duration of the cutout before the spike in seconds</span>
<span class="sd">    :param post: The duration of the cutout after the spike in seconds</span>
<span class="sd">    :param n: The number of cutouts to plot, or None to plot all. Default: 100</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">cutouts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cutouts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">time_in_us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_in_us</span><span class="p">,</span> <span class="n">cutouts</span><span class="p">[</span><span class="n">i</span><span class="p">,],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span> <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now, let’s extract &amp; plot the waveforms.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pre</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="c1"># 1 ms</span>
<span class="n">post</span><span class="o">=</span> <span class="mf">0.002</span> <span class="c1"># 2 ms</span>
<span class="n">waveforms</span> <span class="o">=</span> <span class="n">extract_waveforms</span><span class="p">(</span><span class="n">ephys_data</span><span class="p">,</span> <span class="n">sampling_freq</span><span class="p">,</span> <span class="n">spks</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">)</span>
<span class="n">plot_waveforms</span><span class="p">(</span><span class="n">waveforms</span><span class="p">,</span> <span class="n">sampling_freq</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Looking at the plot above, would you say there is just one waveform here, or multiple?</p>
</div>
<div class="section" id="step-3-feature-extraction">
<h2>Step 3. Feature Extraction<a class="headerlink" href="#step-3-feature-extraction" title="Permalink to this headline">¶</a></h2>
<p>Indeed, it looks like there might be two – one that is very high amplitude, and another that is lower amplitude. We can use <strong>feature extraction</strong> to investigate our waveforms. Below, we’ll plot the minimum and maximum voltages in the recorded waveforms to see if there are distinct clusters of waveforms.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_voltage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">waveforms</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">max_voltage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">waveforms</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">min_voltage</span><span class="p">,</span> <span class="n">max_voltage</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Minimum Voltage (V)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Maximum Voltage (V)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Min/Max Spike Voltages&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Looking at the scatterplot above, would you say there is more than one cluster of waveforms?</p>
<p>For these two units, separating by minimum &amp; maximum voltage actually works fairly well! However, many action potentials have shapes that cannot be easily summarized by one feature such as the minimum voltage. For this, a more general feature extraction method such as principal component analysis (PCA) is typically used.</p>
</div>
<div class="section" id="notebook-summary">
<h2>Notebook summary<a class="headerlink" href="#notebook-summary" title="Permalink to this headline">¶</a></h2>
<p>In this notebook, we’ve looked closely at just 100 seconds of one channel in a 384-channel recording. You can imagine how long spike sorting would take if we needed to do this for <em>all</em> of the data. Thankfully, there are more automated spikesorting tools which enable researchers to automatically sort their data, with just a little bit of sorting by hand. In the next notebook, we’ll work with data that has already been sorted for us. The resulting data simply has spike times for each sorted neuron (or “unit”) – the moments in the experiment where a spike happened. This is the most common format for data sharing of extracellularly recorded data, since it’s much more concise, and the hard work of spike sorting has already happened.</p>
</div>
<div class="section" id="notes-resources">
<h2>Notes &amp; resources<a class="headerlink" href="#notes-resources" title="Permalink to this headline">¶</a></h2>
<p>This notebook borrows inspiration and code from <a class="reference external" href="https://github.com/multichannelsystems/McsPyDataTools/blob/master/McsPyDataTools/docs/McsPy-Tutorial_DataAnalysis.ipynb">this tutorial</a> which is protected under a copyright: Copyright (c) 2018, Multi Channel Systems MCS GmbH
All rights reserved.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "nwb4edu/nwb4edu.github.io",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Chapter_04"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="Large_Scale_Electrophysiology.html" title="previous page">Lesson #2: Analyzing Extracellular Recordings</a>
    <a class='right-next' id="next-link" href="Visualizing_Recordings.html" title="next page">Visualizing Large Scale Recordings</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Ashley Juavinett & Victor Magdaleno-Garcia<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>